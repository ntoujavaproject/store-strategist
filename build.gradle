plugins {
    id 'java' // æ‡‰ç”¨ Java æ’ä»¶
    id 'application' // æ‡‰ç”¨ Application æ’ä»¶ä»¥ä¾¿åŸ·è¡Œ
    id 'org.openjfx.javafxplugin' version '0.0.14' // æ·»åŠ JavaFXæ’ä»¶
}

repositories {
    mavenCentral() // ä½¿ç”¨ Maven ä¸­å¤®å€‰åº«
}

// é…ç½®JavaFX
javafx {
    version = "21"
    modules = ['javafx.controls', 'javafx.fxml', 'javafx.swing', 'javafx.graphics', 'javafx.base']
    // Classifier logic removed - handled by plugin or dependencies
}

dependencies {
    // JavaFX ä¾è³´é … - æ˜ç¢ºæ·»åŠ 
    implementation 'org.openjfx:javafx-controls:21.0.1'
    implementation 'org.openjfx:javafx-fxml:21.0.1'
    implementation 'org.openjfx:javafx-swing:21.0.1'
    implementation 'org.openjfx:javafx-graphics:21.0.1'
    implementation 'org.openjfx:javafx-base:21.0.1'

    // Add JSON library (çµ±ä¸€ä½¿ç”¨ Maven ç‰ˆæœ¬)
    implementation 'org.json:json:20240303' 

    // Add Emoji library for handling emoji codes in reviews
    implementation 'com.vdurmont:emoji-java:5.1.1'
    
    // Jackson å¥—ä»¶ (ç”¨æ–¼ AI åˆ†æåŠŸèƒ½)
    implementation 'com.fasterxml.jackson.core:jackson-core:2.16.1'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.16.1'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.16.1'

    // æ¸¬è©¦å‡½å¼åº« (å¯é¸ï¼Œä½†å»ºè­°åŠ å…¥)
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.9.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.9.2'

    // ç§»é™¤é‡è¤‡çš„æœ¬åœ° JSON åº«ä¾è³´ï¼Œçµ±ä¸€ä½¿ç”¨ Maven ç‰ˆæœ¬
    // implementation files('libs/json-20230227.jar')
}

application {
    // æŒ‡å®šåŒ…å« main æ–¹æ³•çš„ä¸»é¡åˆ¥
    // å¯ä»¥é¸æ“‡åŸ·è¡Œå“ªä¸€å€‹ä¸»é¡åˆ¥
    //mainClass = 'bigproject.compare'  // åŸæœ¬çš„ä¸»é¡åˆ¥  
    //mainClass = 'bigproject.AnimationDemo'  // å‹•ç•«ç¤ºç¯„é¡åˆ¥
    mainClass = 'bigproject.AppLauncher'  // å•Ÿå‹•å™¨é¡åˆ¥ - å•Ÿç”¨AIè‡ªå‹•åˆå§‹åŒ–
    
    // å®šç¾©å¯åŸ·è¡Œçš„æ‡‰ç”¨ç¨‹å¼
    applicationName = 'RestaurantAnalyzer'
    
    // å®šç¾©å¤šå€‹æ‡‰ç”¨ç¨‹å¼ç›®æ¨™
    executableDir = 'bin'
    
    // æ·»åŠ  JVM åƒæ•¸
    applicationDefaultJvmArgs = [
       // '-Dprism.verbose=true', 
       // '-Djavafx.verbose=true',
       // '-Dprism.order=sw' // Keep software rendering if needed, remove otherwise
       // æ·»åŠ æ‰€æœ‰éœ€è¦çš„æ¨¡å¡Š
       '--add-modules', 'java.net.http,java.prefs,javafx.controls,javafx.fxml,javafx.swing,javafx.graphics,javafx.base',
       // æ·»åŠ è‡ªå‹•æ¨¡å¡Šå’Œç¬¬ä¸‰æ–¹åº«çš„è¨ªå•æ¬Šé™
       '--add-modules', 'ALL-MODULE-PATH',
       // æ‰“é–‹æ¨¡å¡Šé‚Šç•Œ
       '--add-opens', 'java.base/java.lang=ALL-UNNAMED',
       '--add-opens', 'javafx.graphics/javafx.scene=ALL-UNNAMED',
       '--add-exports', 'javafx.swing/javafx.embed.swing=ALL-UNNAMED',
       // é‹è¡Œæ™‚å…è¨±ä½¿ç”¨æœªå‘½åæ¨¡å¡Š
       '-Xmx1g', // è¨­ç½®æœ€å¤§å †å…§å­˜ç‚º1GB
       '-Dapple.awt.application.name=Restaurant Analyzer' // è¨­ç½®macOSæ‡‰ç”¨åç¨±
    ]
}

// æ·»åŠ æ‡‰ç”¨ç¨‹å¼ä¿¡æ¯
ext {
    appName = "Restaurant Analyzer"
    appVersion = "1.0.0"
    appVendor = "Restaurant Analyzer Team"
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8' // è¨­å®š Java ç·¨è­¯å™¨ä½¿ç”¨ UTF-8 ç·¨ç¢¼
    // ä½¿ç”¨ --release é¸é …ä¾†çµ±ä¸€è¨­å®š Java ç‰ˆæœ¬ä¸¦ç¦ç”¨é è¦½
    options.compilerArgs = [
        '--release', '21'
    ]
}

tasks.named('test') {
    useJUnitPlatform() // è¨­å®šæ¸¬è©¦ä½¿ç”¨ JUnit Platform
}

// å‰µå»ºä¸€å€‹ä»»å‹™ä¾†æ›´æ–°å•Ÿå‹•è…³æœ¬ä¸­çš„æ‡‰ç”¨ç¨‹å¼åç¨±
task updateStartScripts {
    doLast {
        File windowsScriptFile = new File("${buildDir}/scripts/Restaurant Analyzer.bat")
        File unixScriptFile = new File("${buildDir}/scripts/Restaurant Analyzer")
        
        // ç¢ºä¿ç›®éŒ„å­˜åœ¨
        windowsScriptFile.parentFile.mkdirs()
        unixScriptFile.parentFile.mkdirs()
        
        // å‰µå»ºå•Ÿå‹•è…³æœ¬
        if (!windowsScriptFile.exists()) {
            windowsScriptFile << '@echo off\r\n'
            windowsScriptFile << 'start "Restaurant Analyzer" /B javaw -jar "%~dp0\\..\\lib\\bigproject.jar"\r\n'
        }
        
        if (!unixScriptFile.exists()) {
            unixScriptFile << '#!/bin/sh\n'
            unixScriptFile << 'java -jar "$(dirname "$0")/../lib/bigproject.jar"\n'
            unixScriptFile.setExecutable(true)
        }
    }
}

// å‰µå»ºå¯åŸ·è¡Œçš„ JAR æª”æ¡ˆ
task createExecutableJar(type: Jar) {
    archiveBaseName = project.ext.appName
    archiveVersion = project.ext.appVersion
    
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    manifest {
        attributes(
            'Main-Class': 'bigproject.AppLauncher',
            'Class-Path': configurations.runtimeClasspath.files.collect { it.name }.join(' ')
        )
    }
    
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    
    with jar
}

// å‰µå»ºåŒ…å«æ‰€æœ‰ä¾è³´çš„ Fat JAR (ç”¨æ–¼åˆ†ç™¼)
task createFatJar(type: Jar) {
    archiveBaseName = "${project.ext.appName}-standalone"
    archiveVersion = project.ext.appVersion
    archiveClassifier = 'all'
    
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    manifest {
        attributes(
            'Main-Class': 'bigproject.AppLauncher',
            'Implementation-Title': project.ext.appName,
            'Implementation-Version': project.ext.appVersion,
            'Implementation-Vendor': project.ext.appVendor
        )
    }
    
    // åŒ…å«ä¸»ç¨‹å¼ç¢¼
    from sourceSets.main.output
    
    // åŒ…å«æ‰€æœ‰åŸ·è¡Œæ™‚ä¾è³´ (åŒ…æ‹¬JavaFX)
    from {
        configurations.runtimeClasspath.collect { 
            it.isDirectory() ? it : zipTree(it).matching {
                exclude 'META-INF/MANIFEST.MF'
                exclude 'META-INF/*.SF'
                exclude 'META-INF/*.DSA'
                exclude 'META-INF/*.RSA'
                exclude 'module-info.class'
            }
        }
    }
    
    // ç¢ºä¿æ‰€æœ‰ JavaFX å’Œå…¶ä»–å¿…è¦æ–‡ä»¶è¢«åŒ…å«
    from {
        configurations.runtimeClasspath.findAll { it.name.contains('javafx') }.collect { 
            zipTree(it)
        }
    }
}

// å‰µå»ºä¸€å€‹ä»»å‹™ä¾†å»ºç«‹åˆ†ç™¼åŒ…
task createDistribution(dependsOn: ['jar', 'createExecutableJar']) {
    doLast {
        // å»ºç«‹åˆ†ç™¼ç›®éŒ„
        def distDir = file("${buildDir}/dist/${project.ext.appName}")
        distDir.mkdirs()
        
        // è¤‡è£½å¯åŸ·è¡Œ JAR å’Œä¾è³´çš„ JAR åˆ°åˆ†ç™¼ç›®éŒ„
        copy {
            from tasks.createExecutableJar.archiveFile
            into distDir
        }
        
        // å‰µå»ºå•Ÿå‹•è…³æœ¬
        def winScript = new File(distDir, "${project.ext.appName}.bat")
        winScript.text = "@echo off\r\njava -jar \"${tasks.createExecutableJar.archiveFileName.get()}\"\r\n"
        
        def unixScript = new File(distDir, "${project.ext.appName}.sh")
        unixScript.text = "#!/bin/sh\njava -jar \"${tasks.createExecutableJar.archiveFileName.get()}\"\n"
        unixScript.setExecutable(true)
        
        println "Distribution created at ${distDir.absolutePath}"
    }
} 

task runAnalyzer(type: JavaExec) {
    group = 'application'
    description = 'Run FirestoreRestaurantAnalyzer'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'bigproject.ai.FirestoreRestaurantAnalyzer'
    
    // å…è¨±å¾å‘½ä»¤è¡Œå‚³éåƒæ•¸
    if (project.hasProperty('args')) {
        args project.property('args').split(' ')
    }
}

task runAIDemo(type: JavaExec) {
    description = 'Run AI Progress Dialog Demo'
    group = 'application'
    classpath = sourceSets.main.runtimeClasspath
    mainClass = 'bigproject.ai.AIProgressDialogDemo'
    
    // JavaFX module settings
    jvmArgs += [
        '--add-modules', 'javafx.base,javafx.controls,javafx.fxml,javafx.graphics,javafx.swing',
        '--add-modules', 'java.net.http,java.prefs',
        '--add-modules', 'ALL-MODULE-PATH',
        '--add-opens', 'java.base/java.lang=ALL-UNNAMED',
        '--add-opens', 'javafx.graphics/javafx.scene=ALL-UNNAMED',
        '--add-exports', 'javafx.swing/javafx.embed.swing=ALL-UNNAMED'
    ]
    
    // System properties
    systemProperty 'apple.awt.application.name', 'AI Demo'
    
    // Memory settings
    maxHeapSize = '1g'
}

// å‰µå»ºåŒ…å«JavaFX runtimeçš„å¯åŸ·è¡ŒJAR
task createRuntimeJar(type: Jar) {
    archiveBaseName = "${project.ext.appName}-runtime"
    archiveVersion = project.ext.appVersion
    
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    manifest {
        attributes(
            'Main-Class': 'bigproject.AppLauncher',
            'Implementation-Title': project.ext.appName,
            'Implementation-Version': project.ext.appVersion,
            'Implementation-Vendor': project.ext.appVendor,
            'Class-Path': configurations.runtimeClasspath.files.collect { "libs/" + it.name }.join(' ')
        )
    }
    
    from sourceSets.main.output
    
    doLast {
        // è¤‡è£½æ‰€æœ‰ä¾è³´åˆ°libsç›®éŒ„
        def libsDir = new File(destinationDirectory.get().asFile, "../libs")
        libsDir.mkdirs()
        
        configurations.runtimeClasspath.files.each { file ->
            copy {
                from file
                into libsDir
            }
        }
    }
}

// å‰µå»ºè‡ªåŒ…å«çš„ Java Runtime åŒ… (ä½¿ç”¨ jlink)
task createCustomJRE(type: Exec) {
    description = 'Create a custom JRE using jlink'
    group = 'distribution'
    
    // ç¢ºä¿å…ˆå‰µå»º Fat JAR
    dependsOn createFatJar
    
    doFirst {
        // å‰µå»ºè¼¸å‡ºç›®éŒ„
        def jreDir = file("${buildDir}/jre")
        jreDir.mkdirs()
    }
    
    // ä½¿ç”¨ jlink å‰µå»ºç²¾ç°¡çš„ JRE
    commandLine 'jlink',
        '--add-modules', 'java.base,java.desktop,java.net.http,java.prefs,javafx.controls,javafx.fxml,javafx.swing,javafx.graphics,javafx.base',
        '--output', "${buildDir}/jre",
        '--strip-debug',
        '--no-man-pages',
        '--no-header-files',
        '--compress=2'
}

// å‰µå»º Windows å¯åŸ·è¡Œå®‰è£åŒ…
task createWindowsInstaller(type: Exec) {
    description = 'Create Windows installer using jpackage'
    group = 'distribution'
    
    dependsOn createFatJar, createCustomJRE
    
    onlyIf { org.gradle.internal.os.OperatingSystem.current().isWindows() }
    
    commandLine 'jpackage',
        '--type', 'msi',
        '--input', 'build/libs',
        '--dest', 'build/installers',
        '--name', 'Restaurant Analyzer',
        '--main-jar', "Restaurant Analyzer-standalone-${project.ext.appVersion}-all.jar",
        '--main-class', 'bigproject.AppLauncher',
        '--runtime-image', "${buildDir}/jre",
        '--app-version', project.ext.appVersion,
        '--vendor', project.ext.appVendor,
        '--description', 'AI-powered restaurant analysis tool',
        '--copyright', 'Copyright Â© 2024',
        '--win-dir-chooser',
        '--win-menu',
        '--win-shortcut'
}

// å‰µå»º macOS å¯åŸ·è¡Œå®‰è£åŒ…
task createMacInstaller(type: Exec) {
    description = 'Create macOS installer using jpackage'
    group = 'distribution'
    
    dependsOn createFatJar, createCustomJRE
    
    onlyIf { org.gradle.internal.os.OperatingSystem.current().isMacOsX() }
    
    commandLine 'jpackage',
        '--type', 'dmg',
        '--input', 'build/libs',
        '--dest', 'build/installers',
        '--name', 'Restaurant Analyzer',
        '--main-jar', "Restaurant Analyzer-standalone-${project.ext.appVersion}-all.jar",
        '--main-class', 'bigproject.AppLauncher',
        '--runtime-image', "${buildDir}/jre",
        '--app-version', project.ext.appVersion,
        '--vendor', project.ext.appVendor,
        '--description', 'AI-powered restaurant analysis tool',
        '--copyright', 'Copyright Â© 2024',
        '--mac-package-identifier', 'com.restaurantanalyzer.app'
}

// å‰µå»º Linux å¯åŸ·è¡Œå®‰è£åŒ…
task createLinuxInstaller(type: Exec) {
    description = 'Create Linux installer using jpackage'
    group = 'distribution'
    
    dependsOn createFatJar, createCustomJRE
    
    onlyIf { org.gradle.internal.os.OperatingSystem.current().isLinux() }
    
    commandLine 'jpackage',
        '--type', 'deb',
        '--input', 'build/libs',
        '--dest', 'build/installers',
        '--name', 'restaurant-analyzer',
        '--main-jar', "Restaurant Analyzer-standalone-${project.ext.appVersion}-all.jar",
        '--main-class', 'bigproject.AppLauncher',
        '--runtime-image', "${buildDir}/jre",
        '--app-version', project.ext.appVersion,
        '--vendor', project.ext.appVendor,
        '--description', 'AI-powered restaurant analysis tool',
        '--copyright', 'Copyright Â© 2024',
        '--linux-package-name', 'restaurant-analyzer',
        '--linux-deb-maintainer', 'Restaurant Analyzer Team'
}

// çµ±ä¸€çš„åŸç”Ÿå®‰è£åŒ…å‰µå»ºä»»å‹™
task createNativeInstaller {
    description = 'Create native installer for current platform'
    group = 'distribution'
    
    dependsOn createFatJar
    
    if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {
        dependsOn createWindowsInstaller
    } else if (org.gradle.internal.os.OperatingSystem.current().isMacOsX()) {
        dependsOn createMacInstaller
    } else if (org.gradle.internal.os.OperatingSystem.current().isLinux()) {
        dependsOn createLinuxInstaller
    }
    
    doLast {
        println "âœ… åŸç”Ÿå®‰è£åŒ…å‰µå»ºå®Œæˆï¼"
        println "ğŸ“¦ æª”æ¡ˆä½ç½®: build/installers/"
        
        def installersDir = file("build/installers")
        if (installersDir.exists()) {
            installersDir.listFiles().each { file ->
                println "   ğŸ“„ ${file.name} (${file.length() / (1024*1024)} MB)"
            }
        }
    }
} 