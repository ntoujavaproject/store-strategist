package bigproject;

import com.vdurmont.emoji.EmojiParser;
import javafx.application.Platform;
import javafx.scene.control.Label;
import javafx.scene.control.ProgressBar;
import javafx.scene.control.TextArea;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.VBox;
import javafx.scene.layout.HBox;
import javafx.scene.layout.FlowPane;
import javafx.scene.control.ScrollPane;
import javafx.scene.layout.Priority;
import javafx.geometry.Pos;
import javafx.scene.control.Button;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.concurrent.CompletableFuture;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import java.util.HashSet;
import java.util.Set;
import javafx.scene.effect.BoxBlur;
import javafx.stage.Stage;
import javafx.scene.Scene;
import javafx.stage.Modality;
import javafx.scene.layout.StackPane;
import javafx.geometry.Insets;
import javafx.scene.input.MouseEvent;
import javafx.scene.Cursor;
import javafx.scene.layout.Region;

public class DataManager {

    // --- Load and Display Data from JSON ---
    public void loadAndDisplayRestaurantData(String jsonFilePath, Label ratingsHeader, VBox ratingsBox,
                                           Map<String, ProgressBar> ratingBars,
                                           TextArea reviewsArea, 
                                           FlowPane photosContainer,
                                           TextArea featuresArea) {
        System.out.println("Loading data from: " + jsonFilePath);
        try {
            JSONArray reviews = loadReviewsFromJson(jsonFilePath);
            ratingsBox.getChildren().removeIf(node -> node.getId() != null && node.getId().equals("message-label"));
            photosContainer.getChildren().clear(); // Ê∏ÖÁ©∫ÁÖßÁâáÂÆπÂô®

            if (reviews != null && !reviews.isEmpty()) {
                Map<String, Double> averageScores = calculateAverageRatings(reviews);
                Platform.runLater(() -> {
                    updateRatingBars(averageScores, ratingBars);
                    updateReviewsArea(reviews, reviewsArea);
                    updatePhotosContainer(reviews, photosContainer); // Êõ¥Êñ∞ÁÖßÁâá
                    featuresArea.setText("ÁâπËâ≤ÂàÜÊûê (ÂæÖÂØ¶‰Ωú)...");
                    String restaurantName = jsonFilePath.replace(".json", "").replace(" Info", "");
                    ratingsHeader.setText(restaurantName + " - Á∂úÂêàË©ïÂàÜ");
                });
            } else {
                Platform.runLater(() -> clearRestaurantDataDisplay("ÁÑ°Ê≥ïÂæû " + jsonFilePath + " ËºâÂÖ•Ë©ïË´ñË≥áÊñô",
                                                                  ratingsHeader, ratingsBox, ratingBars, reviewsArea, photosContainer, featuresArea));
            }
        } catch (Exception e) {
            e.printStackTrace();
            Platform.runLater(() -> clearRestaurantDataDisplay("ËÆÄÂèñÊ™îÊ°àÊôÇÁôºÁîüÈåØË™§: " + jsonFilePath,
                                                                  ratingsHeader, ratingsBox, ratingBars, reviewsArea, photosContainer, featuresArea));
        }
    }

    // --- Clear Data Display ---
    public void clearRestaurantDataDisplay(String message, Label ratingsHeader, VBox ratingsBox,
                                         Map<String, ProgressBar> ratingBars,
                                         TextArea reviewsArea,
                                         FlowPane photosContainer,
                                         TextArea featuresArea) {
        ratingsHeader.setText("Á∂úÂêàË©ïÂàÜ");
        ratingBars.values().forEach(bar -> bar.setProgress(0.0));
        ratingsBox.getChildren().removeIf(node -> node.getId() != null && node.getId().equals("message-label"));
        Label messageLabel = new Label(message);
        messageLabel.setId("message-label");
        messageLabel.setStyle("-fx-padding: 10 0 0 0;");
        ratingsBox.getChildren().add(messageLabel);

        reviewsArea.setText("");
        photosContainer.getChildren().clear(); // Ê∏ÖÁ©∫ÁÖßÁâáÂÆπÂô®
        featuresArea.setText("");
    }

    // --- Load JSON Array from File ---
    private JSONArray loadReviewsFromJson(String filePath) throws IOException, JSONException {
        String content = new String(Files.readAllBytes(Paths.get(filePath)));
        return new JSONArray(content);
    }

    // --- Calculate Average Ratings ---
    private Map<String, Double> calculateAverageRatings(JSONArray reviews) {
        Map<String, Double> averageScores = new HashMap<>();
        if (reviews == null || reviews.isEmpty()) {
            return averageScores;
        }

        double totalMealScore = 0, totalServiceScore = 0, totalAmbianceScore = 0;
        int mealCount = 0, serviceCount = 0, ambianceCount = 0;
        List<String> priceLevels = new ArrayList<>();

        for (int i = 0; i < reviews.length(); i++) {
            try {
                JSONObject review = reviews.getJSONObject(i);
                if (review.has("È§êÈªû") && !review.isNull("È§êÈªû")) {
                    totalMealScore += review.optDouble("È§êÈªû", 0.0);
                    mealCount++;
                }
                if (review.has("ÊúçÂãô") && !review.isNull("ÊúçÂãô")) {
                    totalServiceScore += review.optDouble("ÊúçÂãô", 0.0);
                    serviceCount++;
                }
                if (review.has("Ê∞£Ê∞õ") && !review.isNull("Ê∞£Ê∞õ")) {
                    totalAmbianceScore += review.optDouble("Ê∞£Ê∞õ", 0.0);
                    ambianceCount++;
                }
                if (review.has("Âπ≥ÂùáÊØè‰∫∫Ê∂àË≤ª") && !review.isNull("Âπ≥ÂùáÊØè‰∫∫Ê∂àË≤ª")) {
                    priceLevels.add(review.getString("Âπ≥ÂùáÊØè‰∫∫Ê∂àË≤ª"));
                }
            } catch (JSONException e) {
                // Skip review on error
            }
        }

        averageScores.put("È§êÈªû", (mealCount > 0) ? totalMealScore / mealCount : 0.0);
        averageScores.put("ÊúçÂãô", (serviceCount > 0) ? totalServiceScore / serviceCount : 0.0);
        averageScores.put("Áí∞Â¢É", (ambianceCount > 0) ? totalAmbianceScore / ambianceCount : 0.0);
        averageScores.put("ÂÉπÊ†º", estimatePriceRatingValue(priceLevels));

        return averageScores;
    }

    // --- Update Rating Bars ---
    private void updateRatingBars(Map<String, Double> averageScores, Map<String, ProgressBar> ratingBars) {
        // üéØ Áõ¥Êé•Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ùÔºåÊï∏ÂÄºÊ®ôÁ±§ÁöÑÊõ¥Êñ∞Â∞áÁî± RightPanel ÁöÑ updateRatingDisplay ÊñπÊ≥ïËôïÁêÜ
        ratingBars.forEach((category, bar) -> {
            double score = averageScores.getOrDefault(category, 0.0);
            bar.setProgress(score / 5.0);
            System.out.println("Êõ¥Êñ∞ " + category + " Ë©ïÂàÜ: " + score + "/5.0 (ÈÄ≤Â∫¶: " + (score/5.0) + ")");
        });
    }

    // --- Estimate Price Rating Value (Returns 0-5) ---
    private double estimatePriceRatingValue(List<String> priceLevels) {
        if (priceLevels.isEmpty()) return 0.0;
        Map<String, Long> counts = priceLevels.stream()
                .collect(Collectors.groupingBy(e -> e, Collectors.counting()));
        String mostFrequent = counts.entrySet().stream()
                .max(Map.Entry.comparingByValue())
                .map(Map.Entry::getKey)
                .orElse("");

        switch (mostFrequent) {
            case "E:TWD_1_TO_200": return 4.5;
            case "E:TWD_200_TO_400": return 3.5;
            case "E:TWD_400_TO_600": return 2.5;
            case "E:TWD_600_TO_800": return 1.5;
            case "E:TWD_800_TO_1000":
            case "E:TWD_OVER_1000": return 0.5;
            default: return 0.0;
        }
    }

    // --- Update Reviews Text Area ---
    private void updateReviewsArea(JSONArray reviews, TextArea reviewsArea) {
        if (reviews == null || reviews.isEmpty()) {
            reviewsArea.setText("ÁÑ°Ë©ïË´ñË≥áÊñô");
            return;
        }
        StringBuilder sb = new StringBuilder();
        int reviewsToShow = Math.min(10, reviews.length());

        for (int i = 0; i < reviewsToShow; i++) {
            try {
                JSONObject review = reviews.getJSONObject(i);
                String reviewer = review.optString("Ë©ïË´ñËÄÖ", "ÂåøÂêç");
                String commentCode = review.optString("Ë©ïË´ñ", "ÁÑ°Ë©ïË´ñÂÖßÂÆπ");
                String commentText = commentCode != null ? commentCode : "ÁÑ°Ë©ïË´ñÂÖßÂÆπ"; // Á∞°ÂåñËôïÁêÜ
                double rating = review.optDouble("Ë©ïË´ñÂàÜÊï∏", 0.0);
                String date = review.optString("ÁïôË®ÄÊó•Êúü", review.optString("ÁïôË®ÄÊôÇÈñì", "Êú™Áü•ÊôÇÈñì"));

                sb.append(String.format("[%s] %s (%s)\n", formatStars(rating), reviewer, date));
                sb.append(commentText).append("\n");
                
                sb.append("\n");
            } catch (Exception e) {
                // Skip review display on error
                System.err.println("Error displaying review: " + e.getMessage());
            }
        }
        reviewsArea.setText(sb.toString());
        reviewsArea.positionCaret(0);
    }

    // --- Format Stars (Still used for reviews text area) ---
    private String formatStars(double rating) {
        if (rating <= 0) return "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ";
        int fullStars = (int) rating;
        boolean halfStar = (rating - fullStars) >= 0.25 && (rating - fullStars) < 0.75;
        boolean fullPlus = (rating - fullStars) >= 0.75;

        StringBuilder stars = new StringBuilder();
        int calculatedFullStars = fullStars + (fullPlus ? 1 : 0);
        calculatedFullStars = Math.min(calculatedFullStars, 5);

        for (int i = 0; i < calculatedFullStars ; i++) {
            stars.append("‚òÖ");
        }
        if (halfStar && calculatedFullStars < 5) {
            stars.append("¬Ω");
        }

        int symbolsCount = calculatedFullStars + (halfStar && calculatedFullStars < 5 ? 1 : 0);
        int emptyStars = 5 - symbolsCount;
        emptyStars = Math.max(0, emptyStars);

        for (int i = 0; i < emptyStars; i++) {
            stars.append("‚òÜ");
        }
        return stars.toString();
    }

    // --- Êõ¥Êñ∞ÁÖßÁâáÈ°ØÁ§∫ - ÊîπÂñÑÁâàÊú¨ ---
    private void updatePhotosContainer(JSONArray reviews, FlowPane photosContainer) {
        if (reviews == null || reviews.isEmpty()) {
            Label noPhotosLabel = new Label("ÁÑ°ÁÖßÁâáË≥áÊñô");
            noPhotosLabel.setStyle("-fx-text-fill: #555; -fx-font-style: italic;");
            photosContainer.getChildren().add(noPhotosLabel);
            return;
        }
        
        // ‰ΩøÁî®FlowPaneÁõ¥Êé•Ê∑ªÂä†ÁÖßÁâáÔºåÁÑ°ÈúÄÊâãÂãïÁÆ°ÁêÜË°å
        int maxPhotos = 20; // ÊúÄÂ§öÈ°ØÁ§∫ÁöÑÁÖßÁâáÊï∏Èáè
        final int[] photoAdded = {0}; // ‰ΩøÁî®Êï∏ÁµÑÂåÖË£ù‰ª•ÊªøË∂≥effectively finalË¶ÅÊ±Ç
        
        // Á¢∫‰øùÂÆπÂô®ÂèØ‰ª•Ëá™Áî±ÊªæÂãï
        photosContainer.setMaxHeight(Double.MAX_VALUE);
        photosContainer.setMinHeight(Region.USE_COMPUTED_SIZE);
        
        // Ë®≠ÁΩÆÂêàÈÅ©ÁöÑÈñìË∑ùÔºåÊîπÂñÑÁÖßÁâáÊéíÂàó
        photosContainer.setHgap(15);
        photosContainer.setVgap(15);
        photosContainer.setPadding(new Insets(10));
        
        // Ê∏ÖÈô§ÁèæÊúâÂÖßÂÆπ
        photosContainer.getChildren().clear();
        
        // Áî®ÊñºËøΩËπ§Â∑≤È°ØÁ§∫ÈÅéÁöÑË©ïË´ñËÄÖ
        Set<String> displayedReviewers = new HashSet<>();
        
        // ÈÅçÊ≠∑ÊâÄÊúâË©ïË´ñÔºåÂ∞ãÊâæÁÖßÁâá
        for (int i = 0; i < reviews.length(); i++) {
            try {
                JSONObject review = reviews.getJSONObject(i);
                
                // Ê™¢Êü•Ë©ïË´ñËÄÖÊòØÂê¶ÁÇ∫null
                String reviewer = review.optString("Ë©ïË´ñËÄÖ", null);
                if (reviewer == null || reviewer.trim().isEmpty() || reviewer.equals("null")) {
                    continue; // Ë∑≥ÈÅéÊ≤íÊúâË©ïË´ñËÄÖÁöÑË©ïË´ñ
                }
                
                double rating = review.optDouble("Ë©ïË´ñÂàÜÊï∏", 0.0);
                
                // Âö¥Ê†ºÊ™¢Êü•ÔºöÈÅøÂÖçÂêå‰∏ÄË©ïË´ñËÄÖÁöÑÂ§öÂºµÁÖßÁâá
                if (displayedReviewers.contains(reviewer)) {
                    continue;
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÊúâÁÖßÁâáË≥áË®äÔºå‰ª•ÂèäÁÖßÁâáÊòØÂê¶ÊúâÊïà
                if (review.has("ÁÖßÁâá") && !review.isNull("ÁÖßÁâá")) {
                    Object photoObj = review.opt("ÁÖßÁâá");
                    String photoUrl = null;
                    
                    // ÂòóË©¶Âæû‰∏çÂêåÁöÑË≥áÊñôÁµêÊßã‰∏≠Áç≤ÂèñÁÖßÁâáURL
                    if (photoObj instanceof JSONArray) {
                        JSONArray photos = (JSONArray) photoObj;
                        if (photos.length() > 0) {
                            // Âè™ËôïÁêÜÁ¨¨‰∏ÄÂºµÊúâÊïàÁÖßÁâá
                            for (int j = 0; j < photos.length() && photoUrl == null; j++) {
                                try {
                                    if (photos.optJSONArray(j) != null) {
                                        JSONArray photoDetails = photos.getJSONArray(j);
                                        if (photoDetails.length() > 1) {
                                            String tempUrl = photoDetails.optString(1);
                                            if (tempUrl != null && !tempUrl.trim().isEmpty() && !tempUrl.equals("null")) {
                                                photoUrl = tempUrl;
                                            }
                                        }
                                    } else if (photos.optString(j) != null) {
                                        String tempUrl = photos.optString(j);
                                        if (tempUrl != null && !tempUrl.trim().isEmpty() && !tempUrl.equals("null")) {
                                            photoUrl = tempUrl;
                                        }
                                    }
                                } catch (Exception e) {
                                    System.err.println("Error processing photo detail: " + e.getMessage());
                                }
                            }
                        }
                    } else if (photoObj instanceof String) {
                        String tempUrl = (String) photoObj;
                        if (tempUrl != null && !tempUrl.trim().isEmpty() && !tempUrl.equals("null")) {
                            photoUrl = tempUrl;
                        }
                    }
                    
                    // Âè™ÊúâÊâæÂà∞ÊúâÊïàÁöÑÁÖßÁâáURLÊâçÊ∑ªÂä†
                    if (photoUrl != null && !photoUrl.trim().isEmpty() && !photoUrl.equals("null")) {
                        if (photoAdded[0] >= maxPhotos) {
                            // Â¶ÇÊûúË∂ÖÈÅéÊúÄÂ§ßÁÖßÁâáÊï∏ÔºåÂâáË∑≥ÈÅé
                            continue;
                        }
                        
                        addPhotoToContainer(photosContainer, photoUrl, reviewer, rating);
                        photoAdded[0]++;
                        
                        // Ê®ôË®òÊ≠§Ë©ïË´ñËÄÖÂ∑≤È°ØÁ§∫ÈÅéÁÖßÁâá
                        displayedReviewers.add(reviewer);
                    }
                }
            } catch (JSONException e) {
                // Ë∑≥ÈÅéÂá∫ÂïèÈ°åÁöÑË©ïË´ñ
                System.err.println("Error processing review photos: " + e.getMessage());
            }
        }
        
        // Â¶ÇÊûúÊ≤íÊúâÁÖßÁâáË¢´Ê∑ªÂä†
        if (photosContainer.getChildren().isEmpty()) {
            Label noPhotosLabel = new Label("ÁÑ°ÁÖßÁâáË≥áÊñôÊàñÁÑ°Ê≥ïËºâÂÖ•ÁÖßÁâá");
            noPhotosLabel.setStyle("-fx-text-fill: #555; -fx-font-style: italic;");
            photosContainer.getChildren().add(noPhotosLabel);
        }
        
        // Á¢∫‰øùÊâÄÊúâÊõ¥Êñ∞ÂÆåÊàêÂæåËß∏Áôº‰∏ÄÊ¨°‰ΩàÂ±ÄÈáçÁπ™
        Platform.runLater(() -> {
            // Ë®≠ÁΩÆË∂≥Â§†ÁöÑÁ©∫ÈñìËÆìÁÖßÁâáÊéíÂàó‰∏¶ÂÖÅË®±ÊªæÂãï
            if (photoAdded[0] > 6) {  // Â¶ÇÊûúÁÖßÁâáÊï∏ÈáèË∂≥Â§†Â§öÈúÄË¶ÅÊªæÂãï
                // Ë®àÁÆó‰∏ÄÂÄãÂêàÁêÜÁöÑÈ´òÂ∫¶Ôºå‰ΩøÂæóÁÖßÁâáÂçÄÂüüÈúÄË¶ÅÊªæÂãï
                double estimatedHeight = Math.ceil(photoAdded[0] / 3.0) * 240;  // ÂÅáË®≠ÊØèË°åÂ§ßÁ¥Ñ3ÂºµÁÖßÁâáÔºåÊØèÂºµÈ´òÁ¥Ñ240
                photosContainer.setMinHeight(estimatedHeight);
            }
            
            photosContainer.requestLayout();
        });
    }
    
    // --- Ê∑ªÂä†ÂñÆÂºµÁÖßÁâáÂà∞ÂÆπÂô® - ÊîπÂñÑÁâàÊú¨ ---
    private void addPhotoToContainer(FlowPane container, String photoUrl, String reviewer, double rating) {
        try {
            VBox photoBox = new VBox(5);
            photoBox.setAlignment(Pos.CENTER);
            // ‰ΩøÁî®Êõ¥ÊüîÂíåÁöÑÈ¢®Ê†ºÔºå‰∏¶Â¢ûÂä†Â§ñÈÇäË∑ùËÆìÊéíÂàóÊõ¥ÁæéËßÄ
            photoBox.setStyle("-fx-border-color: rgba(111, 103, 50, 0.6); " +
                              "-fx-border-width: 1; " +
                              "-fx-padding: 10; " +
                              "-fx-background-color: rgba(255, 255, 255, 0.6); " +  // ËÉåÊôØÂçäÈÄèÊòé
                              "-fx-background-radius: 10; " +  // ÂúìËßí
                              "-fx-effect: dropshadow(three-pass-box, rgba(0,0,0,0.2), 5, 0, 0, 1), " +
                              "boxblur(10, 10, 3);");  // Ê∑ªÂä†Ê®°Á≥äÊïàÊûú
            photoBox.setMaxWidth(200);
            photoBox.setMinWidth(200);
            photoBox.setMaxHeight(240); // Ê∏õÂ∞èÈ´òÂ∫¶ÔºåÂõ†ÁÇ∫ÊàëÂÄë‰∏çÂÜçÈ°ØÁ§∫Ë©ïË´ñËÄÖ‰ø°ÊÅØ
            photoBox.setMinHeight(200); // Á¢∫‰øùÊúâË∂≥Â§†ÁöÑÊúÄÂ∞èÈ´òÂ∫¶‰ΩÜ‰∏çË¶ÅÂ§™Â§ß
            
            ImageView imageView = new ImageView();
            imageView.setFitWidth(180);
            imageView.setFitHeight(180);
            imageView.setPreserveRatio(true);
            imageView.setStyle("-fx-background-color: #f0f0f0;");
            
            // Ë®≠ÂÆöÊªëÈº†Êá∏ÂÅúÊïàÊûú
            imageView.setCursor(Cursor.HAND); // Êõ¥ÊîπÊ∏∏Ê®ôÁÇ∫ÊâãÂΩ¢
            
            // ÂâµÂª∫ÁÖßÁâáËºâÂÖ•ÊèêÁ§∫
            Label loadingLabel = new Label("Ê≠£Âú®ËºâÂÖ•ÁÖßÁâá...");
            loadingLabel.setStyle("-fx-text-fill: #6F6732;");
            photoBox.getChildren().add(loadingLabel);
            
            // Ê∑ªÂä†Âà∞‰ΩàÂ±Ä‰∏≠ - ÂÖàÊ∑ªÂä†ÂÜçËºâÂÖ•ÂúñÁâáÔºåÁ¢∫‰øùÁïåÈù¢ÈüøÊáâ
            container.getChildren().add(photoBox);
            
            // ÂòóË©¶Áï∞Ê≠•ËºâÂÖ•ÂúñÁâá
            CompletableFuture.runAsync(() -> {
                try {
                    // ‰øÆÊ≠£URLÊ†ºÂºèÂïèÈ°å
                    String cleanUrl = photoUrl.trim().replace("[", "").replace("]", "").replace("\"", "");
                    if (!cleanUrl.startsWith("http")) {
                        cleanUrl = "https:" + cleanUrl;
                    }
                    
                    // ‰øùÂ≠òÊúÄÁµÇÁöÑURL‰ª•‰æøÂú®LambdaË°®ÈÅîÂºè‰∏≠‰ΩøÁî®
                    final String finalUrl = cleanUrl;
                    
                    Image image = new Image(cleanUrl, true); // trueË°®Á§∫Áï∞Ê≠•ËºâÂÖ•
                    
                    Platform.runLater(() -> {
                        if (!image.isError()) {
                            imageView.setImage(image);
                            photoBox.getChildren().clear();
                            photoBox.getChildren().addAll(imageView);
                            
                            // ÁßªÈô§Ë©ïË´ñËÄÖ‰ø°ÊÅØÔºå‰∏çÂÜçÂú®Á∏ÆÂúñÈ°ØÁ§∫ÂêçÁ®±ÂíåÊòüÁ¥ö
                            // ‰ΩÜ‰ªç‰øùÁïôÈªûÊìä‰∫ã‰ª∂Ôºå‰ª•‰æøÂú®ÂÖ®Â∞∫ÂØ∏Ë¶ñÂúñ‰∏≠È°ØÁ§∫‰ø°ÊÅØ
                            
                            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂ - ÈªûÊìäÊîæÂ§ßÊü•Áúã
                            imageView.setOnMouseClicked(event -> showFullSizeImage(finalUrl, reviewer, rating));
                            
                            // Ëß∏ÁôºÂÆπÂô®ÈáçÊñ∞‰ΩàÂ±Ä
                            container.requestLayout();
                        } else {
                            loadingLabel.setText("ÁÑ°Ê≥ïËºâÂÖ•ÂúñÁâá");
                        }
                    });
                } catch (Exception e) {
                    Platform.runLater(() -> loadingLabel.setText("ÂúñÁâáËºâÂÖ•ÈåØË™§"));
                    System.err.println("Error loading image: " + e.getMessage());
                }
            });
            
        } catch (Exception e) {
            System.err.println("Error adding photo to container: " + e.getMessage());
        }
    }
    
    // È°ØÁ§∫ÂÖ®Â∞∫ÂØ∏ÂúñÁâáÁöÑÊñπÊ≥ï
    private void showFullSizeImage(String imageUrl, String reviewer, double rating) {
        try {
            // ÂâµÂª∫‰∏ÄÂÄãÊñ∞ÁöÑÂΩàÂá∫Á™óÂè£
            Stage imageStage = new Stage();
            imageStage.initModality(Modality.APPLICATION_MODAL); // Ë®≠ÁÇ∫Ê®°ÊÖãÁ™óÂè£
            imageStage.setTitle(reviewer + " ÁöÑÁÖßÁâá");
            
            // ÂâµÂª∫‰∏ÄÂÄãÂ§ßÂ∞∫ÂØ∏ÁöÑImageView
            ImageView largeImageView = new ImageView();
            largeImageView.setPreserveRatio(true);
            
            // ‰ΩøÁî®ÂéüÂßãÂúñÁâáÁöÑÂ∞∫ÂØ∏Ôºå‰ΩÜË®≠ÂÆöÊúÄÂ§ßÂ∞∫ÂØ∏
            largeImageView.setFitWidth(800);
            largeImageView.setFitHeight(600);
            
            // ËºâÂÖ•Êõ¥È´òË≥™ÈáèÁöÑÂúñÁâá
            Image largeImage = new Image(imageUrl, 1200, 0, true, true);
            largeImageView.setImage(largeImage);
            
            // ÂâµÂª∫ÈóúÈñâÊåâÈàï
            Button closeButton = new Button("ÈóúÈñâ");
            closeButton.setOnAction(e -> imageStage.close());
            closeButton.setStyle("-fx-background-color: #6F6732; -fx-text-fill: white;");
            
            // ÂâµÂª∫Ë©ïË´ñËÄÖ‰ø°ÊÅØÊ®ôÁ±§
            Label infoLabel = new Label(reviewer + " " + formatStars(rating));
            infoLabel.setStyle("-fx-text-fill: white; -fx-font-weight: bold; -fx-font-size: 14px;");
            
            // Â∞áÂÖÉÁ¥†Ê∑ªÂä†Âà∞‰ΩàÂ±Ä‰∏≠
            VBox vbox = new VBox(10);
            vbox.setAlignment(Pos.CENTER);
            vbox.setPadding(new Insets(20));
            vbox.setStyle("-fx-background-color: rgba(0, 0, 0, 0.8);");
            vbox.getChildren().addAll(largeImageView, infoLabel, closeButton);
            
            // ÂâµÂª∫Â†¥ÊôØ
            Scene scene = new Scene(vbox, 850, 700);
            
            // Ë®≠ÁΩÆÂ†¥ÊôØ‰∏¶È°ØÁ§∫Á™óÂè£
            imageStage.setScene(scene);
            imageStage.show();
            
        } catch (Exception e) {
            System.err.println("Error showing full size image: " + e.getMessage());
        }
    }
} 