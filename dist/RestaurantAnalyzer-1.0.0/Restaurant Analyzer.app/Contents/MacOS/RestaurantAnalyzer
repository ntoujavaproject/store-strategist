#!/bin/bash

# ç²å–æ‡‰ç”¨ç¨‹å¼æŸçš„è·¯å¾‘
APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../Java" && pwd)"

echo "ğŸš€ æ­£åœ¨å•Ÿå‹•é¤å»³åˆ†æå™¨..."
echo "ğŸ“ æ‡‰ç”¨ç¨‹å¼ç›®éŒ„: $APP_DIR"

# æª¢æŸ¥ Java æ˜¯å¦å®‰è£
if ! command -v java &> /dev/null; then
    osascript -e 'display dialog "æœªæ‰¾åˆ° Java\n\nè«‹å®‰è£ Java 21 æˆ–æ›´é«˜ç‰ˆæœ¬\nä¸‹è¼‰åœ°å€: https://www.oracle.com/java/technologies/downloads/" with title "Restaurant Analyzer" buttons {"ç¢ºå®š"} default button "ç¢ºå®š"'
    exit 1
fi

# æª¢æŸ¥ Java ç‰ˆæœ¬
JAVA_VERSION=$(java -version 2>&1 | head -n1 | awk -F '"' '{print $2}' | cut -d'.' -f1)
if [ "$JAVA_VERSION" -lt 21 ]; then
    osascript -e "display dialog \"æª¢æ¸¬åˆ° Java $JAVA_VERSIONï¼Œå»ºè­°ä½¿ç”¨ Java 21 æˆ–æ›´é«˜ç‰ˆæœ¬\" with title \"Restaurant Analyzer\" buttons {\"ç¢ºå®š\"} default button \"ç¢ºå®š\""
fi

# æª¢æŸ¥ Python æ˜¯å¦å®‰è£ (ç”¨æ–¼æ•¸æ“šæ”¶é›†å™¨)
if command -v python3 &> /dev/null; then
    echo "âœ… æª¢æ¸¬åˆ° Python 3"
    # æª¢æŸ¥æ˜¯å¦æœ‰è™›æ“¬ç’°å¢ƒ
    if [ ! -d "$APP_DIR/.venv" ]; then
        echo "ğŸ å‰µå»º Python è™›æ“¬ç’°å¢ƒ..."
        python3 -m venv "$APP_DIR/.venv"
        source "$APP_DIR/.venv/bin/activate"
        if [ -f "$APP_DIR/requirements.txt" ]; then
            echo "ğŸ“¦ å®‰è£ Python ä¾è³´..."
            pip install -r "$APP_DIR/requirements.txt"
        fi
    else
        echo "âœ… ä½¿ç”¨ç¾æœ‰ Python è™›æ“¬ç’°å¢ƒ"
    fi
else
    echo "âš ï¸  è­¦å‘Š: æœªæª¢æ¸¬åˆ° Python 3ï¼Œæ•¸æ“šæ”¶é›†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨"
fi

# åˆ‡æ›åˆ° Java ç›®éŒ„ä¸¦å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
cd "$APP_DIR"
exec ./gradlew run --no-daemon
